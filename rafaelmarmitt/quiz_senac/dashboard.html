<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Usuários - Quiz SENAC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .table-container::-webkit-scrollbar { height: 8px; width: 8px; }
        .table-container::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        .table-container::-webkit-scrollbar-track { background-color: #f1f5f9; }
        .dark .table-container::-webkit-scrollbar-thumb { background-color: #4b5563; }
        .dark .table-container::-webkit-scrollbar-track { background-color: #1f2937; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <header class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Painel de Respostas</h1>
                <p class="text-gray-600 dark:text-gray-400">Visualize os resultados do Quiz Vocacional.</p>
            </div>
            <img src="logo-senac.png" alt="Logo Senac" class="w-32">
        </header>
        
        <!-- Seção de Relatório por Questão -->
        <div id="questions-report-container" class="mb-8">
            <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Relatório por Questão</h2>
            <div id="questions-report" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Cards do relatório serão inseridos aqui -->
            </div>
        </div>

        <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Respostas Individuais</h2>
        <div id="status-message" class="text-center py-4 text-gray-600 dark:text-gray-400">Carregando dados...</div>

        <!-- Container da Tabela com scroll -->
        <div class="table-container overflow-x-auto bg-white dark:bg-gray-800 rounded-lg shadow">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-700">
                    <tr id="table-header">
                        <!-- Cabeçalhos serão gerados dinamicamente -->
                    </tr>
                </thead>
                <tbody id="user-table-body" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                    <!-- Linhas da tabela serão inseridas aqui -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, getDocs, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURAÇÃO DO FIREBASE ---
        const firebaseConfig = {
             apiKey: "AIzaSyBDFhmDLth8b5RUHluJgopvf6iFTdKYhxI",
             authDomain: "quiz-senac-vocacional.firebaseapp.com",
             projectId: "quiz-senac-vocacional",
             storageBucket: "quiz-senac-vocacional.appspot.com",
             messagingSenderId: "816696913380",
             appId: "1:816696913380:web:024f6414b94ca5b75b2bf1",
             measurementId: "G-SNE93NYTFQ"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- LÓGICA DE AUTENTICAÇÃO ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                fetchAndDisplayData();
            } else {
                window.location.href = 'login.html';
            }
        });

        // --- FUNÇÃO PRINCIPAL PARA BUSCAR E EXIBIR DADOS ---
        const fetchAndDisplayData = async () => {
            const statusMessage = document.getElementById('status-message');
            const tableHeader = document.getElementById('table-header');
            const tableBody = document.getElementById('user-table-body');
            const reportContainer = document.getElementById('questions-report');
            
            tableBody.innerHTML = '';
            tableHeader.innerHTML = '';
            reportContainer.innerHTML = '';
            statusMessage.style.display = 'block';
            statusMessage.textContent = 'Carregando estrutura do quiz...';

            try {
                // 1. Buscar a estrutura de perguntas do quiz
                const quizDocRef = doc(db, 'quizzes', 'mainQuiz');
                const quizDocSnap = await getDoc(quizDocRef);
                let questions = [];
                if (quizDocSnap.exists()) {
                    questions = quizDocSnap.data().questions || [];
                } else {
                    console.error("Documento 'quizzes/mainQuiz' não encontrado.");
                    statusMessage.textContent = 'Estrutura do quiz não encontrada. Responda a um quiz para criá-la.';
                    document.getElementById('questions-report-container').style.display = 'none';
                    return;
                }

                // 2. Montar o cabeçalho da tabela detalhada
                let headerHTML = `
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Email</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">CPF</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Telefone</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Perfil</th>
                `;
                questions.forEach(q => {
                    headerHTML += `<th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">${q}</th>`;
                });
                tableHeader.innerHTML = headerHTML;

                // 3. Buscar todas as informações de usuários
                statusMessage.textContent = 'Carregando informações dos usuários...';
                // **CORREÇÃO: Caminho simplificado para a coleção de usuários**
                const usersCollectionRef = collection(db, "users");
                const userDocsSnap = await getDocs(usersCollectionRef);
                const usersMap = new Map();
                userDocsSnap.forEach(doc => {
                    usersMap.set(doc.id, doc.data());
                });

                // 4. Buscar todos os resultados de quizzes
                statusMessage.textContent = 'Carregando resultados dos quizzes...';
                // **CORREÇÃO: Caminho simplificado para a coleção de resultados**
                const resultsCollectionRef = collection(db, "quizResults");
                const quizResultsSnap = await getDocs(query(resultsCollectionRef));

                if (quizResultsSnap.empty) {
                    statusMessage.textContent = 'Nenhum resultado de quiz encontrado.';
                    document.getElementById('questions-report-container').style.display = 'none';
                    return;
                }

                // 5. Processar dados para o relatório e para a tabela
                const questionsSummary = questions.map(q => ({ question: q, yes: 0, no: 0, total: 0 }));

                quizResultsSnap.forEach(resultDoc => {
                    const quizData = resultDoc.data();
                    const userInfo = usersMap.get(quizData.userId) || {};

                    // Preenche a tabela detalhada
                    const row = document.createElement('tr');
                    row.className = "hover:bg-gray-50 dark:hover:bg-gray-700";
                    let rowHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">${userInfo.email || 'Anônimo'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${userInfo.cpf || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${userInfo.phone || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${quizData.profile || '-'}</td>
                    `;
                    questions.forEach((q, index) => {
                        const answer = quizData.answers[index];
                        // Atualiza o resumo para o relatório
                        if (answer === true || answer === false) {
                            questionsSummary[index].total++;
                            if (answer === true) questionsSummary[index].yes++;
                            else questionsSummary[index].no++;
                        }
                        // Monta a célula da tabela
                        let answerCellHTML = '<td class="px-6 py-4 whitespace-nowrap text-sm text-center">';
                        if (answer === true) {
                            answerCellHTML += '<span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800 dark:bg-green-800 dark:text-green-100">Sim</span>';
                        } else if (answer === false) {
                            answerCellHTML += '<span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800 dark:bg-red-800 dark:text-red-100">Não</span>';
                        } else {
                            answerCellHTML += '<span class="text-gray-400">-</span>';
                        }
                        answerCellHTML += '</td>';
                        rowHTML += answerCellHTML;
                    });
                    row.innerHTML = rowHTML;
                    tableBody.appendChild(row);
                });

                // 6. Renderizar o relatório de questões
                questionsSummary.forEach(summary => {
                    const yesPercent = summary.total > 0 ? (summary.yes / summary.total) * 100 : 0;
                    const noPercent = summary.total > 0 ? (summary.no / summary.total) * 100 : 0;

                    const card = document.createElement('div');
                    card.className = "bg-white dark:bg-gray-800 p-4 rounded-lg shadow";
                    card.innerHTML = `
                        <p class="font-semibold text-sm text-gray-800 dark:text-gray-200 truncate mb-3">${summary.question}</p>
                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5 mb-2">
                            <div class="bg-green-500 h-2.5 rounded-full" style="width: ${yesPercent}%"></div>
                        </div>
                        <div class="flex justify-between text-xs text-gray-600 dark:text-gray-400">
                            <span>Sim: ${summary.yes} (${yesPercent.toFixed(0)}%)</span>
                            <span>Não: ${summary.no} (${noPercent.toFixed(0)}%)</span>
                        </div>
                    `;
                    reportContainer.appendChild(card);
                });


                statusMessage.style.display = 'none';

            } catch (error) {
                console.error("Erro ao carregar dados: ", error);
                statusMessage.textContent = 'Falha ao carregar os dados. Verifique o console para mais detalhes.';
                statusMessage.style.color = 'red';
            }
        };
    </script>
</body>
</html>
